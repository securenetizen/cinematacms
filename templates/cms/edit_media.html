{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block headtitle %}Edit Media - {{PORTAL_NAME}}{% endblock headtitle %}

{% block externallinks %}
{% if LOAD_FROM_CDN %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/file-uploader/5.13.0/fine-uploader.min.js" rel="preload" as="script">
<script src="https://cdnjs.cloudflare.com/ajax/libs/file-uploader/5.13.0/fine-uploader.min.js"></script>
{% else %}
<link href="{% static "lib/file-uploader/5.13.0/fine-uploader.min.js" %}" rel="preload" as="script">
<script src="{% static "lib/file-uploader/5.13.0/fine-uploader.min.js" %}"></script>
{% endif %}
{% endblock externallinks %}

{% block topimports %}
<link href="{% static "css/add-media.css" %}" rel="preload" as="style">
<link href="{% static "css/add-media.css" %}" rel="stylesheet">
{% endblock topimports %}

{% block innercontent %}
	<div class="user-action-form-wrap">
		<h1>Edit Media</h1>
		<div class="user-action-form-inner">
			<form enctype="multipart/form-data" action="" method="post" class="post-form">
				{% csrf_token %}

				<p class="requiredField"><span class="asteriskField">*</span> Required</p>

				<span class="editorial-pocicy-notice">Please check our <a href="./editorial-policy" title="Editorial Policy">Editorial Policy</a> before uploading media.</span>

				{% if form.errors %}
				{% for field in form %}
					{% for error in field.errors %}
					   <div class="alert alert-danger">
							<strong>{{ error|escape }}</strong>
					   </div>
					{% endfor %}
				{% endfor %}
			 {% endif %}

			 {% for field in form %}
				 {% if field.name == "media_file" %}
					<div class="fieldWrapper">
						<label for="id_media_file">Media Upload</label>
						<div class="current_media_field" id="current-media-file-info">
							{% if form.instance.media_file %}
								<p>Currently: <a href="{{ form.instance.media_file.url }}" target="_blank">{{ form.instance.media_file.name }}</a></p>
							{% else %}
								<p>No media file uploaded yet.</p>
							{% endif %}
						</div>
						<div class="media-uploader-section" style="
							width: 100%;
							padding: 20px;
							margin-top: 15px;
							border: 2px dashed var(--input-border-color, #ccc);
							background: var(--input-bg-color, #fafafa);
							border-radius: 4px;
							box-sizing: border-box;
							position: relative;
							z-index: 1;
						">
							<p><strong>Upload a new media file (optional):</strong></p>

							<!-- Fine Uploader Template -->
							<script type="text/template" id="qq-template">
								<div class="media-uploader-bottom-wrap qq-uploader-selector">
									<div class="media-uploader-bottom-left-wrap">
										<div class="media-drag-drop-wrap">
											<div class="media-drag-drop-inner" qq-drop-area-text="Drop files here">
												<div class="media-drag-drop-content">
													<div class="media-drag-drop-content-inner">
														<span><i class="material-icons">cloud_upload</i></span>
														<span>Drag and drop file</span>
														<span>or</span>
														<span class="browse-files-btn-wrap">
															<button type="button" class="qq-upload-button-selector primaryAction">Browse your files</button>
														</span>
														<div class="qq-upload-drop-area-selector media-dropzone" qq-hide-dropzone>
															<span class="qq-upload-drop-area-text-selector"></span>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<div class="media-uploader-bottom-right-wrap">
										<ul class="media-upload-items-list qq-upload-list-selector">
											<li>
												<div class="media-upload-item-main">
													<div class="media-upload-item-thumb">
														<img class="qq-thumbnail-selector" qq-max-size="120" qq-server-scale alt="" />
														<span class="media-upload-item-spinner qq-upload-spinner-selector"><i class="material-icons">autorenew</i></span>
														<button type="button" class="qq-upload-retry-selector retry-media-upload-item" aria-label="Retry"><i class="material-icons">refresh</i> Retry</button>
													</div>
													<div class="media-upload-item-details">
														<div class="media-upload-item-name">
															<span class="media-upload-item-filename qq-upload-file-selector"></span>
															<input class="media-upload-item-filename-input qq-edit-filename-selector" tab-index="0" type="text" />
														</div>
														<div class="media-upload-item-details-bottom">
															<div class="media-upload-item-progress-bar-container qq-progress-bar-container-selector">
																<div role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" class="media-upload-item-progress-bar qq-progress-bar-selector"></div>
															</div>
															<span class="media-upload-item-upload-size qq-upload-size-selector"></span>
															<span role="status" class="media-upload-item-status-text qq-upload-status-text-selector"></span>
														</div>
														<div class="media-upload-item-top-actions">
															<span class="filename-edit qq-edit-filename-icon-selector" aria-label="Edit filename">Edit filename <i class="material-icons">create</i></span>
															<button type="button" class="delete-media-upload-item qq-upload-delete-selector" aria-label="Delete">Delete <i class="material-icons">delete</i></button>
															<button type="button" class="cancel-media-upload-item qq-upload-cancel-selector" aria-label="Cancel">Cancel <i class="material-icons">cancel</i></button>
														</div>
														<div class="media-upload-item-bottom-actions">
															<button type="button" class="continue-media-upload-item qq-upload-continue-selector" aria-label="Continue"><i class="material-icons">play_circle_outline</i> Continue</button>
															<button type="button" class="pause-media-upload-item qq-upload-pause-selector" aria-label="Pause"><i class="material-icons">pause_circle_outline</i> Pause</button>
														</div>
													</div>
												</div>
											</li>
										</ul>
									</div>
								</div>
							</script>

							<div class="media-uploader" id="media-file-uploader" style="width: 100%;"></div>
							<div id="upload-status-message" style="margin-top: 10px;"></div>
						</div>
					</div>

				{% elif field.name == "allow_whisper_transcribe" %}

					<div class="fieldWrapper" >
						<div class="transcribe_section_title" style="margin-top: 1.5em; font-size: 120%; font-weight: bold;">
							Automatic Speech Recognition (Beta)
						</div>
						<div id="div_id_allow_whisper_transcribe" class="control-group">
								<div class="controls">
										<label for="id_allow_whisper_transcribe" class="checkbox ">
											{{ field}}
											<span class="normal_label" style="font-weight: normal !important;">{{ field.label}}</span>
										</label>
								</div>
						</div>
					</div>

					{% elif field.name == "allow_whisper_transcribe_and_translate" %}
					<div class="fieldWrapper">
						<div id="div_id_allow_whisper_transcribe_and_translate" class="control-group">
								<div class="controls">
										<label for="id_allow_whisper_transcribe_and_translate" class="checkbox ">
											{{ field}}
											<span class="normal_label" style="font-weight: normal !important;">{{ field.label}}</span>
										</label>
								</div>
						</div>

						<div class="transcribe_section_title" style="margin-top: 1.5em; font-size: 120%">
							To view or edit auto-generated subtitles, go to the Media page and click Edit Subtitles after uploading the video file.
						</div>

					</div>


				{% elif field.name == "uploaded_poster" %}
					<div class="fieldWrapper">
						{{ field.errors }}
						{{ field.label_tag }} <div class="current_uploaded_poster_field">{{ field }} </div>
					</div>

				{% elif field.name == "custom_license" %}
                                        <div class="fieldWrapper">

											<div id="div_id_custom_license" class="control-group">

                                            	<label for="id_{{field.name}}" class="control-label ">License</label>

                                            	<input type="hidden" class="license-hidden-field" id="id_{{field.name}}" name="{{field.name}}" value="{{field.value}}" />

												<div class="license_controls">

													<div class="license_controls_header">
														<span class="selected-license-title"></span>
														<button type="button" title="Choose license" class="open-licenses-options">Choose</button>
													</div>
													<div class="license_controls_options is-hidden">

														<div>
															<div>
																<div class="license-form">

																	<div class="license-form-content">

																		<p>Creative Commons licenses help you share your work while keeping your copyright. Other people can copy and distribute your work provided they <a href="https://creativecommons.org/characteristic/by?lang=en" target="_blank" onclick="window.open('http://creativecommons.org/characteristic/by?lang=en', 'characteristic_help', 'width=375,height=300,scrollbars=yes,resizable=yes,toolbar=no,directories=no,location=yes,menubar=no,status=yes'); return false;">give you credit</a> -- and only on the conditions you specify here. This page helps you choose those conditions.</p>
																		<p>If you want to share a work you created with no conditions, choose <a href="https://creativecommons.org/choose/zero/partner?partner_icon_url=https://mediacms.engagemedia.org/static/images/em_cc_logo.jpeg" target="_blank" onclick="window.open('https://creativecommons.org/choose/zero/partner?partner_icon_url=https://mediacms.engagemedia.org/static/images/em_cc_logo.jpeg', 'characteristic_help', 'width=375,height=300,scrollbars=yes,resizable=yes,toolbar=no,directories=no,location=yes,menubar=no,status=yes'); return false;">CC0</a>. If you're sharing a work that isn't covered by copyright or on which the copyright has expired, choose the <a href="https://creativecommons.org/choose/mark/partner?partner_icon_url=https://mediacms.engagemedia.org/static/images/em_cc_logo.jpeg" target="_blank" onclick="window.open('https://creativecommons.org/choose/mark/partner?partner_icon_url=https://mediacms.engagemedia.org/static/images/em_cc_logo.jpeg', 'characteristic_help', 'width=375,height=300,scrollbars=yes,resizable=yes,toolbar=no,directories=no,location=yes,menubar=no,status=yes'); return false;">Public Domain Mark</a>.</p>

																		<div class="license-radio-options">

																			<p>
																				<span><strong>Allow commercial uses of your work?</strong> (<a href="https://creativecommons.org/characteristic/nc?lang=en_US" target="_blank" onclick="window.open('https://creativecommons.org/characteristic/nc?lang=en_US', 'characteristic_help', 'width=375,height=300,scrollbars=yes,resizable=yes,toolbar=no,directories=no,location=yes,menubar=no,status=yes'); return false;">more info</a>)</span>
																				<label><input type="radio" name="field_commercial" value="Yes"/>Yes</label>
																				<label><input type="radio" name="field_commercial" value="No"/>No</label>
																			</p>

																			<p>
																				<span><strong>Allow modifications of your work?</strong> (<a href="https://creativecommons.org/characteristic/nd?lang=en_US" target="_blank" onclick="window.open('https://creativecommons.org/characteristic/nd?lang=en_US', 'characteristic_help', 'width=375,height=300,scrollbars=yes,resizable=yes,toolbar=no,directories=no,location=yes,menubar=no,status=yes'); return false;">more info</a>)</span>
																				<label><input type="radio" name="field_derivatives" value="Yes"/>Yes</label>
																				<label><input type="radio" name="field_derivatives" value="Partially"/>Yes, as long as others share alike (<a href="https://creativecommons.org/characteristic/sa?lang=en_US" target="_blank" onclick="window.open('https://creativecommons.org/characteristic/sa?lang=en_US', 'characteristic_help', 'width=375,height=300,scrollbars=yes,resizable=yes,toolbar=no,directories=no,location=yes,menubar=no,status=yes'); return false;">more info</a>)</label>
																				<label><input type="radio" name="field_derivatives" value="No"/>No</label>
																			</p>
																		</div>

																		<p><em>Note:</em> To license a work, you must be its copyright holder or have express authorization from its copyright holder to do so.</p>
																		<p>Creative Commons does not provide legal advice or services. We provide form legal documents; the rest is up to you.</p>

																	</div>

																	<div class="license-form-buttons">
																		<button type="button" class="btn-close-license">CANCEL</button>
																		<button type="button" class="btn-choose-license">UPDATE LICENSE</button>
																	</div>

																</div>
															</div>
														</div>

													</div>

												</div>
											</div>

                                        </div>

				    {% else %}
                                        <div class="fieldWrapper">
                                            {{ field|as_crispy_field }}
                                        </div>
				    {% endif %}
                                {% endfor %}

                                <button class="primaryAction" type="submit">Update Media</button>
                        </form>
                </div>
        </div>

        <style>

			.license_controls{}

			.license_controls_header{
				position:relative;
				padding-right: 96px;
			}

			.license_controls_header span{
				width:100%;
				min-height: 36px;
				display: block;
				line-height:1.3;
				padding:0.57142875em;
				border-radius: 1px 0 0 1px;
				border-style:solid;
				border-width:1px 0 1px 1px;
				border-color: var(--input-border-color);
				background-color: var(--input-bg-color);
			}

			.license_controls_header button{
				position:absolute;
				top:0;
				right:0;
				bottom:0;
				padding:0;
				width:96px;
			}

			.license_controls_options {
				position:fixed;
				top:56px;
				left:0;
				right:0;
				bottom:0;
				z-index:+1;
				display:block;
			}

			.license_controls_options.is-hidden{
				display:none;
			}

			.license_controls_options:before{
				content:"";
				position:absolute;
				display:block;
				top:0;
				left:0;
				right:0;
				bottom:0;
				background-color:rgba(0,0,0, 0.5);
			}

			.license_controls_options > div {
				display:table;
				width:100%;
				height:100%;
			}

			.license_controls_options > div > div {
				display:table-cell;
				vertical-align: middle;
			}

			.license_controls_options .license-form{
				position:relative;
				display:block;
				width:100%;
				max-width: 640px;
				margin:0 auto;
				box-shadow: 0 16px 24px 2px rgba(0, 0, 0, 0.14), 0 6px 30px 5px rgba(0, 0, 0, 0.12), 0 8px 10px -5px rgba(0, 0, 0, 0.4);
				background-color: var(--user-action-form-inner-bg-color);
			}

			.license_controls_options .license-form p{
				margin:0 0 12px;
			}

			.license_controls_options .license-form p:last-child{
				margin-bottom:0;
			}

			.license_controls_options .license-form p a{
				margin:0;
			}

			.license_controls_options .license-form strong{
				font-weight:500;
			}

			.license_controls_options .license-form label input{
				margin-left:0;
			}

			.license_controls_options .license-form .license-radio-options {
				display:block;
				margin-bottom:16px;
			}

			.license_controls_options .license-form .license-radio-options p{
				margin:0;
				border-radius: 1px;
				padding-bottom:6px;
				background-color: var(--body-bg-color);
			}

			.license_controls_options .license-form .license-radio-options p + p {
				margin-top:4px;
			}

			.license_controls_options .license-form .license-radio-options p span{
				display: block;
				padding:12px 16px;
				margin-bottom:6px;
				border-bottom:1px solid;
				border-color: var(--input-border-color);
			}

			.license_controls_options .license-form .license-radio-options p label{
				width:100%;
				padding:6px 16px;
			}

			.license_controls_options .license-form-content{
				position:relative;
				display:block;
				padding:24px 24px;
				max-height:70vh;
				overflow:auto;
			}

			.license_controls_options .license-form-buttons{
				position:relative;
				display:inline-block;
				width:100%;
				float:left;
				padding:16px 24px;
				border-top: 1px solid var(--body-bg-color);
				background-color: var(--user-action-form-inner-bg-color);
			}

			.license_controls_options .license-form-buttons button{
				position:relative;
				display:inline-block;
				line-height:38px;
				padding:0 12px;
			}

			.license_controls_options .license-form-buttons button.btn-close-license{
				float:left;
			}

			.license_controls_options .license-form-buttons button.btn-choose-license{
				float:right;
			}


			#div_id_no_license .controls{
				margin-top:0.5em;
			}

			#div_id_no_license .controls label{
				margin-top:0;
			}

        </style>
                {{ licenses|json_script:"licenses-data" }}

        <script type="text/javascript">

			// add eventlistener on document.querySelector('#div_id_state select')
			// when value is 'restricted', show div with id div_id_password. Otherwise hide it
			function show_password_field() {
				if (document.querySelector('#div_id_password') !== null) {


					if (document.querySelector('#div_id_state select').value === 'restricted') {
						document.querySelector('#div_id_password').style.display = 'block';
					} else {
						document.querySelector('#div_id_password').style.display = 'none';
					}
				}
			}

			document.querySelector('#div_id_state select').addEventListener('change', show_password_field);

			// set correct text
			document.querySelector('label[for="id_uploaded_poster"]').innerHTML = 'Thumbnail Image Upload';

			if (document.querySelector('label[for="id_media_file"]') !== null) {
				document.querySelector('label[for="id_media_file"]').innerHTML = 'Media Upload';
			}


			// change text to classes that start with current_
			Array.from(document.querySelectorAll("[class^=current_]")).forEach(function(el) {
				el.outerHTML = (el.outerHTML.replace('Currently:', 'Current File'));
			});

			// fix href
			if (document.querySelector('.current_media_field a') !== null) {

				// fix name
				let currentMediaFilePath = document.querySelector('.current_media_field a').innerText;
				let tempList = currentMediaFilePath.split('/');
				let currentMediaFileName = tempList[tempList.length -1];

				// The href is already correct from Django, just fix the display name
				document.querySelector('.current_media_field a').innerText = currentMediaFileName;
			}

			let currentUploadedPosterFilePath = document.querySelector('.current_uploaded_poster_field a');

			if(currentUploadedPosterFilePath !== null) {
				currentUploadedPosterFilePath = currentUploadedPosterFilePath.innerText;
				tempList = currentUploadedPosterFilePath.split('/');
				let currentUploadedPosterFileName = tempList[tempList.length -1];

				// fix href
				currentUploadedPosterFilePath = document.querySelector('.current_uploaded_poster_field a').href;
				tempList = currentUploadedPosterFilePath.split('/media_files/');
				let currentUploadedPosterFileNameURL = `/media/${tempList[tempList.length -1]}`;
				document.querySelector('.current_uploaded_poster_field a').innerText = currentUploadedPosterFileName;
				document.querySelector('.current_uploaded_poster_field a').href = currentUploadedPosterFileNameURL;

				document.querySelector('#uploaded_poster-clear_id').remove();
				document.getElementsByClassName('current_uploaded_poster_field')[0].querySelector('label').remove();

			}



			// remove some fields
			document.querySelector('#hint_id_allow_download').remove();
			document.querySelector('#hint_id_enable_comments').remove();
			document.querySelector('#hint_id_year_produced').remove();


			// increase titles
			const field_labels = document.querySelectorAll('label');
			field_labels.forEach((label) => {
				label.style.fontSize = '140%';
				label.style.fontWeight = 'bold';

			});

			document.querySelector('.requiredField').style.fontSize = '120%';
			document.querySelector('.requiredField').style.fontWeight = 'bold';
			document.querySelector('.requiredField').style.color = 'white';

        	function removeClassname(el, cls) {
			    if (el.classList) {
			        el.classList.remove(cls);
			    } else {
			        el.className = el.className.replace(new RegExp('(^|\\b)' + cls.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
			    }
			}

			function addClassname(el, cls) {
			    if (el.classList) {
			        el.classList.add(cls);
			    } else {
			        el.className += ' ' + cls;
			    }
			}

        	var isLicensePopupOpen = false;
        	var isLicenseDisabled = false;

	        var selectedFields = {
	        	commercial: null,
	        	derivatives: null,
	        };

			document.addEventListener("DOMContentLoaded", function(event) {

                var licenses = JSON.parse( JSON.parse(document.getElementById('licenses-data').textContent) );

				var elem = {
					selected_license_title: document.querySelector('.selected-license-title'),
					license_value_field: document.querySelector('input[name="custom_license"]'),
					popup: document.querySelector('.license_controls_options'),
					btn: {
						openPopup: document.querySelector('.open-licenses-options'),
						closePopup: document.querySelector('.btn-close-license'),
						chooseLicense: document.querySelector('.btn-choose-license'),
					},
					license_input:  {
						commercial: document.querySelectorAll('input[name="field_commercial"]'),
						derivatives: document.querySelectorAll('input[name="field_derivatives"]'),
					},
					license_disable_check: document.querySelector('input[name="no_license"]'),
				};

				var init_license_fields = ( function( defaultValue ){

					if( null !== elem.license_disable_check ){

						if( "none" === elem.license_value_field.value || "None" === elem.license_value_field.value ){
							isLicenseDisabled = true;
							elem.license_disable_check.checked = true;
						}
						else{
							isLicenseDisabled = elem.license_disable_check.checked;
						}
					}

					let k;
					let found = false;

					for(k in licenses){

						if( licenses.hasOwnProperty(k) ){

							if( defaultValue === k.toString() ){

								found = true;

								if( ! isLicenseDisabled ){
									elem.selected_license_title.innerHTML = licenses[k].title;
								}

								selectedFields.commercial = licenses[k].allow_commercial;
								selectedFields.derivatives = licenses[k].allow_modifications;

								update_license_fields();
							}
						}
					}

					if( ! isLicenseDisabled && ! found ){
						isLicenseDisabled = true;
						elem.license_disable_check.checked = true;
					}

					if( isLicenseDisabled ){
						elem.selected_license_title.innerHTML = "-";
					}

				}).bind(this);

				var update_license_fields = (function(){

					if( null === selectedFields.commercial || null === selectedFields.derivatives ){
						elem.selected_license_title.innerHTML = '';
						return;
					}

					var commercialValue = selectedFields.commercial;
					var derivativesValue = selectedFields.derivatives;

					var commercialInput = elem.license_input.commercial;
					var derivativesInput = elem.license_input.derivatives;

					var i;

					if( null !== commercialInput && commercialInput.length ){
						i = 0;
						while(i<commercialInput.length){
							if( commercialInput[i].value === commercialValue ){
								commercialInput[i].checked = true;
							}
							else{
								commercialInput[i].checked = false;
							}
							i += 1;
						}
					}

					if( null !== derivativesInput && derivativesInput.length ){
						i = 0;
						while(i<derivativesInput.length){
							if( derivativesInput[i].value === derivativesValue ){
								derivativesInput[i].checked = true;
							}
							else{
								derivativesInput[i].checked = false;
							}
							i += 1;
						}
					}

				}).bind(this);

				function on_open_popup(ev){
					removeClassname(elem.popup, 'is-hidden');
					isLicensePopupOpen = true;
				}

				function on_close_popup(ev){
					addClassname(elem.popup, 'is-hidden');
					isLicensePopupOpen = false;
				}

				function on_license_choose(ev){

					addClassname(elem.popup, 'is-hidden');

					isLicensePopupOpen = false;
					selectedFields.commercial = selectedFields.commercial;
					selectedFields.derivatives = selectedFields.derivatives;

					if( null !== elem.selected_license_title ){

						let k;
						for(k in licenses){

							if( licenses.hasOwnProperty(k) ){

								if( selectedFields.commercial === licenses[k].allow_commercial && selectedFields.derivatives === licenses[k].allow_modifications ){

									elem.selected_license_title.innerHTML = licenses[k].title;
									elem.license_value_field.setAttribute('value', k);

									isLicenseDisabled = false;
									elem.license_disable_check.checked = false;
								}
							}
						}
					}
				}

				function on_commercial_option_change(ev){
					selectedFields.commercial = ev.target.value;
				}

				function on_derivatives_option_change(ev){
					selectedFields.derivatives = ev.target.value;
				}

				function on_license_disable_change(ev){

					isLicenseDisabled = elem.license_disable_check.checked;

					if( isLicenseDisabled ){
						elem.selected_license_title.innerHTML = '-';
					}
					else if( null === selectedFields.commercial || null === selectedFields.derivatives ){
						elem.selected_license_title.innerHTML = '';
						return;
					}
					else{
						let k;
						for(k in licenses){
							if( licenses.hasOwnProperty(k) ){
								if( selectedFields.commercial === licenses[k].allow_commercial && selectedFields.derivatives === licenses[k].allow_modifications ){
									elem.selected_license_title.innerHTML = licenses[k].title;
								}
							}
						}
					}
				}

				var button_events = ( function(){

					if( null !== elem.btn.openPopup ){
						elem.btn.openPopup.addEventListener( 'click', on_open_popup.bind(this));
					}

					if( null !== elem.btn.closePopup ){
						elem.btn.closePopup.addEventListener( 'click', on_close_popup.bind(this));
					}

					if( null !== elem.btn.chooseLicense ){
						elem.btn.chooseLicense.addEventListener( 'click', on_license_choose.bind(this));
					}

				}).bind(this);

				var input_events = ( function(){

					var commercialInput = elem.license_input.commercial;
					var derivativesInput = elem.license_input.derivatives;

					var i;

					if( null !== commercialInput && commercialInput.length ){
						i = 0;
						while(i<commercialInput.length){
							commercialInput[i].addEventListener( 'change', on_commercial_option_change.bind(this));
							i += 1;
						}
					}

					if( null !== derivativesInput && derivativesInput.length ){
						i = 0;
						while(i<derivativesInput.length){
							derivativesInput[i].addEventListener( 'change', on_derivatives_option_change.bind(this));
							i += 1;
						}
					}

					if( null !== elem.license_disable_check ){
						elem.license_disable_check.addEventListener( 'change', on_license_disable_change.bind(this));
					}

				}).bind(this);

				if( null !== elem.popup && null !== elem.license_value_field ){
					button_events();
					input_events();
					init_license_fields( elem.license_value_field.value.toString() );
				}

			});

			// run show_password_field() only when the DOM has loaded
			document.addEventListener("DOMContentLoaded", function(event) {
				show_password_field();
			});

        </script>

		<style>
			/* Animations for upload progress */
			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}

			@keyframes pulse {
				0% {
					box-shadow: 0 0 0 0 rgba(231, 162, 123, 0.4);
				}
				70% {
					box-shadow: 0 0 0 10px transparent;
				}
				100% {
					box-shadow: 0 0 0 0 transparent;
				}
			}

			.rotating {
				animation: spin 2s linear infinite;
			}

			/* Match button padding to other buttons on the page */
			.secondaryAction {
				padding: 1em 2em !important;
			}

			/* Ensure the media uploader section is interactive */
			.media-uploader-section {
				position: relative !important;
				z-index: 1 !important;
				overflow: visible !important;
			}

			/* Style the Fine Uploader component */
			#media-file-uploader {
				position: relative;
				z-index: 10;
			}

			#media-file-uploader .media-uploader-bottom-wrap {
				width: 100%;
				display: flex;
				flex-direction: column;
				align-items: center;
				position: relative;
				z-index: 10;
			}

			#media-file-uploader .media-uploader-bottom-left-wrap {
				width: 100%;
				max-width: 600px;
				margin-bottom: 20px;
			}

			#media-file-uploader .media-drag-drop-wrap {
				width: 100%;
				position: relative;
				z-index: 10;
			}

			#media-file-uploader .media-drag-drop-inner {
				width: 100%;
				min-height: 200px;
				display: flex;
				align-items: center;
				justify-content: center;
				text-align: center;
				position: relative;
				z-index: 10;
			}

			#media-file-uploader .media-drag-drop-content {
				width: 100%;
				position: relative;
				z-index: 10;
			}

			#media-file-uploader .media-drag-drop-content-inner {
				padding: 20px;
			}

			#media-file-uploader .media-drag-drop-content-inner span {
				display: block;
				margin: 10px 0;
			}

			#media-file-uploader .media-uploader-bottom-right-wrap {
				width: 100%;
				min-height: 0 !important;
			}

			/* Hide the upload list container when it has items */
			#media-file-uploader .media-uploader-bottom-right-wrap:has(li) {
				display: none !important;
			}

			/* Make the browse button clickable */
			#media-file-uploader .qq-upload-button-selector {
				cursor: pointer !important;
				pointer-events: auto !important;
				position: relative !important;
				z-index: 100 !important;
				display: inline-block !important;
				padding: 10px 20px !important;
				border: none !important;
			}

			#media-file-uploader .browse-files-btn-wrap {
				display: block;
				margin-top: 10px;
				position: relative;
				z-index: 100;
				pointer-events: auto;
			}

			#media-file-uploader .browse-files-btn-wrap * {
				pointer-events: auto;
			}

			/* Ensure the drop zone is interactive */
			#media-file-uploader .qq-upload-drop-area-selector {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				z-index: 5;
			}

			/* Fix for hidden file input - ensure it's accessible but hidden */
			#media-file-uploader input[type="file"] {
				position: absolute !important;
				left: 0 !important;
				top: 0 !important;
				width: 100% !important;
				height: 100% !important;
				opacity: 0 !important;
				cursor: pointer !important;
				z-index: 101 !important;
			}

			/* Ensure the uploader is visible */
			#media-file-uploader .qq-uploader {
				min-height: 200px;
			}

			/* Upload list styling - hide default Fine Uploader list */
			#media-file-uploader .qq-upload-list {
				display: none !important;
			}

			/* Hide successful upload items from taking space */
			#media-file-uploader .qq-upload-success {
				display: none !important;
			}

			/* Hide all list items to prevent them from taking space */
			#media-file-uploader .qq-upload-list-selector li {
				display: none !important;
			}

			/* Hide filename editing elements */
			#media-file-uploader .qq-edit-filename-selector,
			#media-file-uploader .media-upload-item-filename-input {
				display: none !important;
			}

			/* Hide edit filename button */
			#media-file-uploader .qq-edit-filename-icon-selector,
			#media-file-uploader .filename-edit {
				display: none !important;
			}

			/* Ensure the filename span is visible but not editable */
			#media-file-uploader .media-upload-item-filename {
				display: inline-block !important;
			}

			/* Make upload list items more compact */
			#media-file-uploader .media-upload-items-list {
				margin: 0;
				padding: 0;
			}

			#media-file-uploader .media-upload-items-list li {
				margin: 0;
				padding: 10px;
				background: var(--input-bg-color);
				border: 1px solid var(--input-border-color);
				border-radius: 4px;
			}

			#media-file-uploader .media-upload-item-main {
				display: flex;
				align-items: center;
				gap: 15px;
			}

			#media-file-uploader .media-upload-item-thumb {
				flex-shrink: 0;
				width: 60px;
				height: 60px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			#media-file-uploader .media-upload-item-thumb img {
				max-width: 100%;
				max-height: 100%;
				object-fit: cover;
			}

			#media-file-uploader .media-upload-item-details {
				flex: 1;
				min-width: 0;
			}

			#media-file-uploader .media-upload-item-name {
				margin-bottom: 5px;
			}

			#media-file-uploader .media-upload-item-top-actions,
			#media-file-uploader .media-upload-item-bottom-actions {
				display: flex;
				gap: 10px;
				margin-top: 5px;
			}

			#media-file-uploader .media-upload-item-top-actions button,
			#media-file-uploader .media-upload-item-bottom-actions button {
				padding: 4px 8px;
				font-size: 0.85em;
			}

			/* Custom upload progress container */
			.upload-progress-container {
				padding: 40px;
				text-align: center;
				background: var(--input-bg-color);
				border: 2px dashed var(--input-border-color);
				border-radius: 4px;
				margin: 20px 0;
				animation: fadeIn 0.3s ease-in;
			}

			/* Ensure dashed border is visible in dark mode */
			.dark_theme .upload-progress-container {
				border-color: rgba(255, 255, 255, 0.2);
			}

			.dark_theme .media-uploader-section {
				border-color: rgba(255, 255, 255, 0.2) !important;
			}

			.upload-progress-icon {
				margin-bottom: 20px;
			}

			.upload-progress-icon .material-icons {
				font-size: 48px;
				color: var(--text-color);
			}

			.upload-progress-title {
				color: var(--text-color);
				margin: 10px 0;
				font-size: 1.5em;
				font-weight: 500;
				font-family: 'Amulya', sans-serif;
				text-align: left;
				word-wrap: break-word;
				white-space: normal;
				max-width: 100%;
			}

			.upload-progress-title.success {
				color: var(--success-color, #4CAF50);
			}

			.upload-progress-title.error {
				color: var(--error-color, #f44336);
			}

			.upload-progress-bar-wrapper {
				width: 100%;
				background: var(--input-border-color, #ddd);
				border-radius: 10px;
				overflow: hidden;
				height: 30px;
				margin: 20px 0;
			}

			.upload-progress-bar {
				width: 0%;
				height: 100%;
				background: var(--default-brand-color, #e7a27b);
				transition: width 0.3s ease;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.upload-progress-text {
				color: white;
				font-weight: bold;
			}

			.upload-progress-message {
				color: var(--text-color);
				margin: 10px 0;
				text-align: left;
				font-family: 'Amulya', sans-serif;
			}

			.upload-notice-box {
				padding: 15px;
				background: var(--body-bg-color);
				border: 1px solid var(--default-theme-color);
				border-left-width: 4px;
				margin: 20px auto;
				text-align: left;
				max-width: 500px;
			}

			.upload-notice-box p {
				color: var(--text-color);
				margin: 5px 0;
			}

			.success-state .upload-progress-icon .material-icons {
				color: var(--success-color, #4CAF50);
			}

			.error-state .upload-progress-icon .material-icons {
				color: var(--error-color, #f44336);
			}

			.cancel-state .upload-progress-icon .material-icons {
				color: var(--warning-color, #ff9800);
			}

			.success-text {
				color: var(--text-color);
			}


			/* Compact success message styles */
			.upload-progress-container.compact {
				padding: 20px;
			}

			.upload-success-compact {
				display: flex;
				flex-direction: column;
				gap: 12px;
				text-align: left;
			}

			.success-icon-title {
				display: flex;
				align-items: center;
				gap: 10px;
				font-size: 1.2em;
				color: var(--text-color);
			}

			.success-icon-title .material-icons {
				font-size: 24px;
				color: var(--text-color);
			}

			.success-icon-title .success-title {
				font-weight: 600;
				font-family: 'Amulya', sans-serif;
			}

			.success-details {
				display: flex;
				flex-direction: column;
				align-items: flex-start;
				gap: 5px;
				padding: 10px 15px;
				background: var(--body-bg-color);
				border-radius: 4px;
				border: 1px solid var(--input-border-color);
			}

			/* Ensure border is visible in dark mode */
			.dark_theme .success-details {
				border-color: rgba(255, 255, 255, 0.2);
			}

			.success-details .file-name {
				color: var(--text-color);
				font-weight: 500;
				flex: 1;
				font-family: 'Amulya', sans-serif;
				word-wrap: break-word;
				white-space: normal;
			}

			.success-details .file-size {
				color: var(--text-color);
				font-size: 0.9em;
				white-space: nowrap;
				font-family: 'Amulya', sans-serif;
			}

			.success-notice {
				display: flex;
				align-items: flex-start;
				gap: 8px;
				padding: 12px;
				background: var(--body-bg-color);
				border: 1px solid var(--input-border-color);
				border-radius: 2px;
				text-align: left;
			}

			/* Ensure border is visible in dark mode */
			.dark_theme .success-notice {
				border-color: rgba(255, 255, 255, 0.2);
			}

			.success-notice .material-icons {
				font-size: 20px;
				color: var(--text-color);
				flex-shrink: 0;
			}

			.success-notice span {
				color: var(--text-color);
				font-size: 0.9em;
				line-height: 1.4;
				font-family: 'Amulya', sans-serif;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(-10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			/* Ensure responsive layout */
			@media (max-width: 768px) {
				.media-uploader-section {
					padding: 15px !important;
				}

				#media-file-uploader .media-uploader-bottom-left-wrap {
					max-width: 100%;
				}

				#media-file-uploader .media-drag-drop-inner {
					min-height: 150px;
				}

				/* Compact success message on mobile */
				.upload-progress-container.compact {
					padding: 15px;
				}

				.success-icon-title {
					font-size: 1.1em;
				}

				.success-details {
					flex-direction: column;
					align-items: flex-start;
					gap: 5px;
				}

				.success-notice {
					padding: 10px;
				}

				.success-notice span {
					font-size: 0.85em;
				}
			}
		</style>

		<script>
		// Initialize shared upload state on window object for cross-scope access
		window._uploadState = {
			inProgress: false,
			completed: false,
			currentUploadId: null,
			formSubmitButton: null,
			originalButtonText: '',
			uploadStatusMessage: null
		};

		// Utility function to get CSRF token - must be accessible globally
		function getCSRFToken() {
			var i, cookies, cookie, cookieVal = null;
			if (document.cookie && '' !== document.cookie) {
				cookies = document.cookie.split(';');
				i = 0;
				while(i < cookies.length){
					cookie = cookies[i].trim();
					if ('csrftoken=' === cookie.substring(0, 10)) {
						cookieVal = decodeURIComponent(cookie.substring(10));
						break;
					}
					i += 1;
				}
			}
			return cookieVal;
		}

		// Function to cancel upload and clean up
		function cancelUpload() {
			// Call the cancel endpoint to clean up session and temp files
			fetch('{% url 'uploader:cancel' form.instance.friendly_token %}', {
				method: 'POST',
				headers: {
					'X-CSRFToken': getCSRFToken(),
					'Content-Type': 'application/json',
				},
				credentials: 'same-origin'
			}).then(function(response) {
				return response.json();
			}).then(function(data) {
				if (data.success) {
					console.log('Upload cancelled successfully');
					// Reload the page to reset the upload interface
					location.reload();
				} else {
					console.error('Failed to cancel upload:', data.error);
					// Still reload to reset the UI
					location.reload();
				}
			}).catch(function(error) {
				console.error('Error cancelling upload:', error);
				// Still reload to reset the UI
				location.reload();
			});
		}

		document.addEventListener("DOMContentLoaded", function(event) {
			// Initialize DOM element references in upload state
			window._uploadState.formSubmitButton = document.querySelector('.user-action-form-wrap button[type="submit"]');
			window._uploadState.originalButtonText = window._uploadState.formSubmitButton ? window._uploadState.formSubmitButton.textContent : '';
			window._uploadState.uploadStatusMessage = document.getElementById('upload-status-message');

			// HTML escaping utility to prevent XSS attacks
			function escapeHtml(text) {
				if (text == null) return '';
				var map = {
					'&': '&amp;',
					'<': '&lt;',
					'>': '&gt;',
					'"': '&quot;',
					"'": '&#039;',
					'/': '&#x2F;'
				};
				return String(text).replace(/[&<>"'\/]/g, function(char) {
					return map[char];
				});
			}

			function formatBytes(bytes) {
				if (bytes === 0) return '0 Bytes';
				var k = 1024;
				var sizes = ['Bytes', 'KB', 'MB', 'GB'];
				var i = Math.floor(Math.log(bytes) / Math.log(k));
				return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
			}

			function updateFormState() {
				if (!window._uploadState.formSubmitButton) return;

				if (window._uploadState.inProgress) {
					window._uploadState.formSubmitButton.disabled = true;
					window._uploadState.formSubmitButton.textContent = 'Upload in progress...';
					window._uploadState.formSubmitButton.style.opacity = '0.5';
					window._uploadState.formSubmitButton.style.cursor = 'not-allowed';
				} else {
					window._uploadState.formSubmitButton.disabled = false;
					window._uploadState.formSubmitButton.textContent = window._uploadState.originalButtonText;
					window._uploadState.formSubmitButton.style.opacity = '1';
					window._uploadState.formSubmitButton.style.cursor = 'pointer';
				}
			}

			// Initialize Fine Uploader
			var mediaFileUploader = new qq.FineUploader({
				debug: true,
				element: document.getElementById('media-file-uploader'),
				template: document.getElementById('qq-template'),
				request: {
					endpoint: '{% url 'uploader:update' form.instance.friendly_token %}',
					customHeaders: {
						'X-CSRFToken': getCSRFToken(),
					},
				},
				retry: {
					enableAuto: true,
					maxAutoAttempts: 2,
				},
				validation: {
					itemLimit: 1,
					sizeLimit: {{UPLOAD_MAX_SIZE}},
					allowedExtensions: {{ allowed_extensions|safe }},
					acceptFiles: 'video/*',
				},
				chunking: {
					enabled: true,
					concurrent: {
						enabled: true,
					},
					success: {
						endpoint: '{% url 'uploader:update' form.instance.friendly_token %}?done',
					},
				},
				callbacks: {
					onSubmit: function(id, name) {
						window._uploadState.inProgress = true;
						window._uploadState.completed = false;
						window._uploadState.currentUploadId = id;
						updateFormState();

						// Hide the drag-drop interface and show progress
						var dragDropArea = document.querySelector('#media-file-uploader .media-drag-drop-wrap');
						var uploadList = document.querySelector('#media-file-uploader .qq-upload-list');

						if (dragDropArea) {
							dragDropArea.style.display = 'none';
						}

						// Create and show progress UI
						var progressContainer = document.getElementById('upload-progress-container');
						if (!progressContainer) {
							progressContainer = document.createElement('div');
							progressContainer.id = 'upload-progress-container';
							progressContainer.className = 'upload-progress-container';

							var uploaderDiv = document.getElementById('media-file-uploader');
							if (uploaderDiv.firstChild) {
								uploaderDiv.insertBefore(progressContainer, uploaderDiv.firstChild);
							} else {
								uploaderDiv.appendChild(progressContainer);
							}
						}

						progressContainer.innerHTML =
							'<div class="upload-progress-icon">' +
								'<i class="material-icons rotating">autorenew</i>' +
							'</div>' +
							'<h3 class="upload-progress-title" title="' + escapeHtml(name) + '">Uploading: ' + escapeHtml(name) + '</h3>' +
							'<div class="upload-progress-bar-wrapper">' +
								'<div id="upload-progress-bar" class="upload-progress-bar">' +
									'<span id="upload-progress-text" class="upload-progress-text">0%</span>' +
								'</div>' +
							'</div>' +
							'<p class="upload-progress-message">Uploading your file, please wait</p>' +
							'<button type="button" id="cancel-upload-btn" class="secondaryAction" style="margin-top: 20px;">Cancel</button>';

						// Add cancel button event listener
						setTimeout(function() {
							var cancelBtn = document.getElementById('cancel-upload-btn');
							if (cancelBtn) {
								cancelBtn.addEventListener('click', function() {
									if (window._uploadState.currentUploadId !== null) {
										mediaFileUploader.cancel(window._uploadState.currentUploadId);
									}
								});
							}
						}, 100);

						if (uploadList) {
							uploadList.style.display = 'block';
						}
					},
					onProgress: function(id, name, uploadedBytes, totalBytes) {
						if (totalBytes > 0) {
							var percent = Math.round((uploadedBytes / totalBytes) * 100);
							var progressBar = document.getElementById('upload-progress-bar');
							var progressText = document.getElementById('upload-progress-text');

							if (progressBar) {
								progressBar.style.width = percent + '%';
							}
							if (progressText) {
								progressText.textContent = percent + '%';
							}
						}
					},
					onError: function(id, name, errorReason, xhrOrXdr) {
						window._uploadState.inProgress = false;
						updateFormState();

						// Show error in progress container
						var progressContainer = document.getElementById('upload-progress-container');
						if (progressContainer) {
							progressContainer.className = 'upload-progress-container error-state';
							progressContainer.innerHTML =
								'<div class="upload-progress-icon">' +
									'<i class="material-icons">error_outline</i>' +
								'</div>' +
								'<h3 class="upload-progress-title error">Upload Failed</h3>' +
								'<p class="upload-progress-message">' + escapeHtml(errorReason || '') + '</p>' +
								'<button onclick="location.reload()" class="button primaryAction">Try Again</button>';
						}

						console.warn(qq.format("Error on file number {} - {}.  Reason: {}", id, name, errorReason));
					},
					onComplete: function(id, name, response, request) {
						window._uploadState.inProgress = false;
						updateFormState();

						if(response.success){
							window._uploadState.completed = true;

							// Show success message with instruction to save
							var progressContainer = document.getElementById('upload-progress-container');
							if (progressContainer) {
								progressContainer.className = 'upload-progress-container success-state compact';

								// Get file size from uploader if available
								var fileSize = '';
								try {
									var file = mediaFileUploader.getFile(id);
									if (file && file.size) {
										fileSize = formatBytes(file.size);
									}
								} catch(e) {}

								progressContainer.innerHTML =
									'<div class="upload-success-compact">' +
										'<div class="success-icon-title">' +
											'<i class="material-icons">check_circle</i>' +
											'<span class="success-title">Upload Complete!</span>' +
										'</div>' +
										'<div class="success-details">' +
											'<span class="file-name">' + escapeHtml(name) + '</span>' +
											(fileSize ? '<span class="file-size">' + fileSize + '</span>' : '') +
										'</div>' +
										'<div class="success-notice">' +
											'<i class="material-icons">info</i>' +
											'<span>File uploaded. Click "Update Media" below to save.</span>' +
										'</div>' +
										'<div style="text-align: right; margin-top: 15px;">' +
											'<button type="button" class="secondaryAction" onclick="cancelUpload()">Cancel</button>' +
										'</div>' +
									'</div>';
							}

							// Update current file info
							var currentFileInfo = document.getElementById('current-media-file-info');
							if (currentFileInfo) {
								currentFileInfo.innerHTML = '<p class="success-text"><strong>New file ready:</strong> ' + escapeHtml(name) + ' (not saved yet)</p>';
							}
						} else {
							// Show error in progress container
							var progressContainer = document.getElementById('upload-progress-container');
							if (progressContainer) {
								progressContainer.className = 'upload-progress-container error-state';
								progressContainer.innerHTML =
									'<div class="upload-progress-icon">' +
										'<i class="material-icons">error_outline</i>' +
									'</div>' +
									'<h3 class="upload-progress-title error">Upload Failed</h3>' +
									'<p class="upload-progress-message">Please try again.</p>' +
									'<button onclick="location.reload()" class="button primaryAction">Try Again</button>';
							}
						}
					},
					onCancel: function(id, name) {
						window._uploadState.inProgress = false;
						updateFormState();

						// Call the cancel endpoint to clean up session and temp files
						fetch('{% url 'uploader:cancel' form.instance.friendly_token %}', {
							method: 'POST',
							headers: {
								'X-CSRFToken': getCSRFToken(),
								'Content-Type': 'application/json',
							},
							credentials: 'same-origin'
						}).then(function(response) {
							return response.json();
						}).then(function(data) {
							if (data.success) {
								console.log('Upload cancelled and temporary files cleaned up');
							} else {
								console.error('Failed to clean up cancelled upload:', data.error);
							}
						}).catch(function(error) {
							console.error('Error calling cancel endpoint:', error);
						});

						// Show cancelled state
						var progressContainer = document.getElementById('upload-progress-container');
						if (progressContainer) {
							progressContainer.className = 'upload-progress-container cancel-state';
							progressContainer.innerHTML =
								'<div class="upload-progress-icon">' +
									'<i class="material-icons">cancel</i>' +
								'</div>' +
								'<h3 class="upload-progress-title" style="text-align: center;">Upload Cancelled</h3>' +
								'<p class="upload-progress-message" style="text-align: center;">Your upload has been cancelled. You can upload a different file or keep the current media file.</p>' +
								'<div style="text-align: center; margin-top: 15px;">' +
									'<button onclick="cancelUpload()" class="button primaryAction">Upload a Different File</button>' +
								'</div>';
						}
					}
				}
			});

			// Prevent form submission while upload is in progress
			var form = document.querySelector('.post-form');
			if (form) {
				form.addEventListener('submit', function(e) {
					if (window._uploadState.inProgress) {
						e.preventDefault();
						alert('Please wait for the file upload to complete before saving.');
						return false;
					}
				});
			}
		});
		</script>

{% endblock innercontent %}

